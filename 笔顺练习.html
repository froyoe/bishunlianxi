<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>å†™å­—å°è¯¾å ‚</title>
<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
:root {
  --primary: #5b8ff9; --primary-light: #e8f0fe; --success: #52c41a;
  --danger: #ff4d4f; --warning: #faad14; --bg: #f0f5ff;
  --card: #fff; --text: #333; --text-light: #999; --radius: 16px;
}
body { font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-user-select: none; user-select: none; }

/* é¡¶éƒ¨æ  */
.header { background: linear-gradient(135deg, #5b8ff9, #7b61ff); color: #fff; padding: 14px 16px; display: flex; align-items: center; gap: 10px; position: sticky; top: 0; z-index: 10; }
.header h1 { font-size: 20px; flex: 1; text-align: center; }
.back-btn { background: rgba(255,255,255,.25); border: none; color: #fff; font-size: 22px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; line-height: 40px; text-align: center; visibility: hidden; }
.back-btn.show { visibility: visible; }
.back-btn:active { background: rgba(255,255,255,.4); }
.sound-btn { background: rgba(255,255,255,.25); border: none; color: #fff; font-size: 18px; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; line-height: 36px; text-align: center; }
.sound-btn:active { background: rgba(255,255,255,.4); }
.home-btn { background: rgba(255,255,255,.25); border: none; color: #fff; font-size: 20px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; line-height: 40px; text-align: center; visibility: hidden; }
.home-btn.show { visibility: visible; }
.home-btn:active { background: rgba(255,255,255,.4); }

.container { max-width: 560px; margin: 0 auto; padding: 12px 16px 32px; }

/* ===== å•å…ƒé€‰æ‹© ===== */
.unit-card { background: var(--card); border-radius: var(--radius); padding: 18px 16px; margin-bottom: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(91,143,249,.12); display: flex; align-items: center; gap: 14px; transition: transform .15s; }
.unit-card:active { transform: scale(.97); }
.unit-icon { font-size: 32px; width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.unit-card h3 { font-size: 18px; font-weight: 600; }
.unit-card .progress-text { font-size: 13px; color: var(--text-light); margin-top: 4px; }
.unit-card .arrow { color: #ccc; font-size: 22px; margin-left: auto; }
/* è¿›åº¦æ¡ */
.progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-top: 6px; overflow: hidden; }
.progress-bar .fill { height: 100%; background: linear-gradient(90deg, #52c41a, #73d13d); border-radius: 3px; transition: width .3s; }

/* ===== ç”Ÿå­—ç½‘æ ¼ ===== */
.lesson-title { font-size: 15px; color: var(--primary); font-weight: 600; margin: 16px 0 8px; padding-left: 4px; }
.lesson-title:first-child { margin-top: 4px; }
.char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
.char-cell { background: var(--card); border-radius: 14px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 40px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,.06); position: relative; border: 3px solid transparent; transition: .15s; }
.char-cell:active { transform: scale(.93); }
.char-cell.mastered { border-color: var(--success); background: #f6ffed; }
.char-cell.struggling { border-color: var(--danger); background: #fff2f0; }
.char-cell .stars { font-size: 12px; margin-top: 2px; line-height: 1; }
.char-cell .difficult-dot { position: absolute; top: 5px; right: 5px; font-size: 14px; }

/* ===== ç»ƒä¹ é¡µ ===== */
.practice-page { display: none; flex-direction: column; align-items: center; }
.practice-header { text-align: center; margin: 16px 0 12px; }
.practice-header .big-char { font-size: 48px; font-weight: 700; }
.practice-header .char-tag { display: inline-block; background: #fff0e0; color: #fa8c16; font-size: 13px; padding: 2px 10px; border-radius: 10px; margin-top: 4px; }

/* ç”°å­—æ ¼ */
.writer-wrap { position: relative; width: min(320px, 85vw); height: min(320px, 85vw); border: 3px solid #bbb; border-radius: 10px; background: #fff; }
.writer-wrap .tian-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
.writer-wrap .tian-grid::before, .writer-wrap .tian-grid::after {
  content: ''; position: absolute;
}
.writer-wrap .tian-grid::before { top: 50%; left: 0; width: 100%; height: 0; border-top: 1px dashed #d9d9d9; }
.writer-wrap .tian-grid::after { left: 50%; top: 0; width: 0; height: 100%; border-left: 1px dashed #d9d9d9; }
/* å¯¹è§’è™šçº¿ç”¨ SVG */
.tian-diag { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

.feedback-area { margin-top: 14px; min-height: 60px; text-align: center; }
.feedback-text { font-size: 22px; font-weight: 700; }
.feedback-text.correct { color: var(--success); }
.feedback-text.wrong { color: var(--danger); }
.feedback-text.hint { color: var(--primary); }
.feedback-emoji { font-size: 36px; margin-top: 4px; }
.stats-stars { font-size: 14px; color: var(--text-light); margin-top: 4px; }

/* å¤§æŒ‰é’® */
.btn-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; justify-content: center; }
.btn { padding: 14px 28px; border: none; border-radius: 14px; font-size: 17px; font-weight: 600; cursor: pointer; color: #fff; display: flex; align-items: center; gap: 6px; transition: transform .1s; }
.btn:active { transform: scale(.95); }
.btn-primary { background: linear-gradient(135deg, #5b8ff9, #7b61ff); }
.btn-success { background: linear-gradient(135deg, #52c41a, #73d13d); }
.btn-warning { background: linear-gradient(135deg, #faad14, #ffc53d); color: #333; }
.btn-outline { background: #fff; color: var(--primary); border: 2px solid var(--primary); }
.btn-next { background: linear-gradient(135deg, #ff7a45, #ff9c6e); }
.btn-small { padding: 10px 18px; font-size: 15px; border-radius: 10px; }

/* ===== æ€»ç»“é¡µ ===== */
.summary-page { display: none; }
.summary-header { text-align: center; margin: 20px 0; }
.summary-header h2 { font-size: 22px; }
.summary-header .big-emoji { font-size: 48px; margin-bottom: 8px; }
.summary-header .sub { font-size: 14px; color: var(--text-light); margin-top: 4px; }
.summary-list { background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
.summary-item { display: flex; align-items: center; padding: 14px 16px; border-bottom: 1px solid #f5f5f5; }
.summary-item:last-child { border-bottom: none; }
.summary-item .ch { font-size: 32px; width: 52px; text-align: center; }
.summary-item .info { flex: 1; font-size: 14px; color: var(--text-light); padding-left: 8px; }
.summary-item .badge { padding: 5px 12px; border-radius: 14px; font-size: 13px; font-weight: 600; }
.badge-star { background: #f6ffed; color: var(--success); }
.badge-try { background: #fff7e6; color: #fa8c16; }
.badge-new { background: #f0f5ff; color: var(--primary); }
.badge-hard { background: #fff2f0; color: var(--danger); }

/* ===== åº†ç¥åŠ¨ç”» ===== */
.celebrate { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
.confetti { position: absolute; width: 10px; height: 10px; border-radius: 2px; animation: confetti-fall 1.5s ease-out forwards; }
@keyframes confetti-fall {
  0% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
  100% { opacity: 0; transform: translateY(80vh) rotate(720deg) scale(0.5); }
}

/* é¡µé¢åˆ‡æ¢åŠ¨ç”» */
.fade-in { animation: fadeIn .25s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* é”™è¯¯æç¤ºåŠ¨ç”» */
@keyframes slideDown {
  from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}
@keyframes slideUp {
  from { opacity: 1; transform: translateX(-50%) translateY(0); }
  to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
}

/* é¡µé¢éšè— */
.page-hidden { display: none !important; }

/* åº•éƒ¨å®‰å…¨åŒº */
.bottom-safe { height: env(safe-area-inset-bottom, 20px); }
</style>
</head>
<body>

<div class="header">
  <button class="back-btn" id="backBtn" onclick="goBack()">&#8592;</button>
  <h1 id="headerTitle">&#9997;&#65039; å†™å­—å°è¯¾å ‚</h1>
  <button class="sound-btn" id="soundBtn" onclick="toggleSound()">&#128264;</button>
  <button class="home-btn" id="homeBtn" onclick="renderUnits()">&#127968;</button>
</div>

<div class="container" id="mainContainer">
  <div id="unitList"></div>

  <div id="charPage" class="page-hidden"></div>

  <div class="practice-page page-hidden" id="practicePage">
    <div class="practice-header" id="practiceHeader"></div>
    <div class="writer-wrap" id="writerWrap">
      <div class="tian-grid"></div>
      <svg class="tian-diag" viewBox="0 0 100 100" preserveAspectRatio="none">
        <line x1="0" y1="0" x2="100" y2="100" stroke="#e8e8e8" stroke-width="0.5" stroke-dasharray="3,3"/>
        <line x1="100" y1="0" x2="0" y2="100" stroke="#e8e8e8" stroke-width="0.5" stroke-dasharray="3,3"/>
      </svg>
      <div id="writerTarget"></div>
    </div>
    <div class="feedback-area" id="feedbackArea"></div>
    <div class="stats-stars" id="statsStars"></div>
    <div class="btn-row" id="practiceButtons"></div>
  </div>

  <div class="summary-page page-hidden" id="summaryPage"></div>
</div>
<div class="bottom-safe"></div>

<script>
// ===== éŸ³æ•ˆå¼•æ“ï¼ˆWeb Audio APIï¼Œæ— éœ€å¤–éƒ¨æ–‡ä»¶ï¼‰=====
let soundEnabled = localStorage.getItem('bishun_sound') !== 'off';
function toggleSound() {
  soundEnabled = !soundEnabled;
  localStorage.setItem('bishun_sound', soundEnabled ? 'on' : 'off');
  document.getElementById('soundBtn').innerHTML = soundEnabled ? '&#128264;' : '&#128263;';
  if (soundEnabled) SFX.tap();
}
let audioCtx = null;
function ensureAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
// iOS éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ¿€æ´» AudioContext
document.addEventListener('touchstart', ensureAudio, { once: true });
document.addEventListener('click', ensureAudio, { once: true });

function playTone(freq, duration, type, vol, delay) {
  if (!soundEnabled) return;
  const ctx = ensureAudio();
  const t = ctx.currentTime + (delay || 0);
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = type || 'sine';
  osc.frequency.setValueAtTime(freq, t);
  gain.gain.setValueAtTime(vol || 0.3, t);
  gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start(t);
  osc.stop(t + duration);
}

const SFX = {
  // ç‚¹å‡»æŒ‰é’®/å¡ç‰‡ï¼šè½»å¿«çŸ­ä¿ƒ
  tap() { playTone(800, 0.08, 'sine', 0.15); },

  // å†™å¯¹ä¸€ç¬”ï¼šæ¸…è„†ä¸Šæ‰¬
  correct() { playTone(880, 0.12, 'sine', 0.25); playTone(1100, 0.15, 'sine', 0.2, 0.08); },

  // å†™é”™ä¸€ç¬”ï¼šä½æ²‰æŸ”å’Œ
  wrong() { playTone(300, 0.2, 'triangle', 0.2); playTone(250, 0.25, 'triangle', 0.15, 0.1); },

  // å…¨éƒ¨æ­£ç¡®å®Œæˆï¼šæ¬¢å¿«ä¸Šè¡Œæ—‹å¾‹
  perfect() {
    playTone(523, 0.15, 'sine', 0.25);        // C5
    playTone(659, 0.15, 'sine', 0.25, 0.12);   // E5
    playTone(784, 0.15, 'sine', 0.25, 0.24);   // G5
    playTone(1047, 0.3, 'sine', 0.3, 0.36);    // C6
  },

  // å®Œæˆä½†æœ‰é”™è¯¯ï¼šæ¸©å’Œä¸¤å£°
  done() { playTone(523, 0.18, 'sine', 0.2); playTone(659, 0.22, 'sine', 0.2, 0.15); },

  // ç¬”é¡ºåŠ¨ç”»çœ‹å®Œï¼šå®
  ready() { playTone(1047, 0.2, 'sine', 0.15); playTone(1319, 0.25, 'sine', 0.12, 0.12); },
};

// ===== è¯­éŸ³æ’­æŠ¥ï¼ˆSpeechSynthesisï¼‰=====
function speak(text, rate) {
  if (!soundEnabled || !window.speechSynthesis) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-CN';
  u.rate = rate || 0.85;
  u.volume = 1;
  speechSynthesis.speak(u);
}
// ä¸æ‰“æ–­å½“å‰è¯­éŸ³ï¼Œè¿½åŠ åˆ°é˜Ÿåˆ—
function speakQueue(text, rate) {
  if (!soundEnabled || !window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'zh-CN';
  u.rate = rate || 0.8;
  u.volume = 1;
  speechSynthesis.speak(u);
}

// ===== ç¬”ç”»åç§°è¯†åˆ« =====
let currentStrokeNames = [];
let strokeSpeechTimers = [];
// ç¬”ç”»æ•°æ®ç¼“å­˜ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
const strokeCache = new Map();

function clearStrokeSpeech() {
  strokeSpeechTimers.forEach(t => clearTimeout(t));
  strokeSpeechTimers = [];
  if (window.speechSynthesis) speechSynthesis.cancel();
}

// å¸¦é‡è¯•å’Œç¼“å­˜çš„ç½‘ç»œè¯·æ±‚ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
async function fetchWithRetry(url, retries = 3, delay = 1000) {
  let timeoutId;
  const timeoutPromise = new Promise((_, reject) => {
    timeoutId = setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 5000);
  });
  
  for (let i = 0; i < retries; i++) {
    try {
      const fetchPromise = fetch(url).then(resp => {
        clearTimeout(timeoutId);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return resp.json();
      });
      
      const result = await Promise.race([fetchPromise, timeoutPromise]);
      return result;
    } catch (e) {
      clearTimeout(timeoutId);
      if (i === retries - 1) throw e;
      await new Promise(r => setTimeout(r, delay * (i + 1))); // é€’å¢å»¶è¿Ÿ
    }
  }
}

// æ£€æŸ¥localStorageé…é¢
function checkStorageQuota() {
  try {
    const test = '__storage_test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
      return false;
    }
    return true;
  }
}

// æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆé¿å…é‡å¤æç¤ºï¼‰
let currentErrorDiv = null;
function showError(message, duration = 3000) {
  // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æç¤º
  if (currentErrorDiv) {
    currentErrorDiv.remove();
    currentErrorDiv = null;
  }
  
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error-toast';
  errorDiv.style.cssText = `
    position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
    background: #ff4d4f; color: #fff; padding: 12px 20px;
    border-radius: 8px; z-index: 1000; font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideDown 0.3s ease;
    max-width: 90%; word-wrap: break-word;
  `;
  errorDiv.textContent = message;
  document.body.appendChild(errorDiv);
  currentErrorDiv = errorDiv;
  
  setTimeout(() => {
    if (currentErrorDiv === errorDiv) {
      errorDiv.style.animation = 'slideUp 0.3s ease';
      setTimeout(() => {
        if (currentErrorDiv === errorDiv) {
          errorDiv.remove();
          currentErrorDiv = null;
        }
      }, 300);
    }
  }, duration);
}

// ä» HanziWriter CDN è·å–å­—çš„ median æ•°æ®ï¼Œè¯†åˆ«ç¬”ç”»åç§°ï¼ˆå¸¦ç¼“å­˜å’Œé”™è¯¯å¤„ç†ï¼‰
async function loadStrokeNames(ch) {
  // å…ˆæ£€æŸ¥ç¼“å­˜
  if (strokeCache.has(ch)) {
    currentStrokeNames = strokeCache.get(ch);
    return;
  }

  try {
    const url = 'https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/' + encodeURIComponent(ch) + '.json';
    const data = await fetchWithRetry(url);
    currentStrokeNames = data.medians.map(classifyStroke);
    // ç¼“å­˜ç»“æœï¼ˆé™åˆ¶ç¼“å­˜å¤§å°ï¼Œé¿å…å†…å­˜æº¢å‡ºï¼‰
    if (strokeCache.size < 100) {
      strokeCache.set(ch, currentStrokeNames);
    }
  } catch (e) {
    console.error('åŠ è½½ç¬”ç”»æ•°æ®å¤±è´¥:', e);
    currentStrokeNames = [];
    // ç½‘ç»œé”™è¯¯æ—¶ç»™å‡ºå‹å¥½æç¤º
    if (!navigator.onLine) {
      showError('ğŸ“¡ ç½‘ç»œæœªè¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
    } else {
      showError('âš ï¸ åŠ è½½ç¬”ç”»æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
}

// æ ¹æ® median åæ ‡ç‚¹åºåˆ—æ¨æ–­ç¬”ç”»ç±»å‹
// HanziWriter æ•°æ®ä½¿ç”¨æ•°å­¦åæ ‡ç³»ï¼ˆy è½´å‘ä¸Šï¼‰ï¼Œéœ€ç¿»è½¬ y æ‰æ˜¯ä¹¦å†™è§†è§‰æ–¹å‘
function classifyStroke(median) {
  if (!median || median.length < 2) return 'ç‚¹';

  // æ•´ä½“ä½ç§»ï¼ˆç¿»è½¬ y è½¬ä¸ºå±å¹•åæ ‡ï¼‰
  const tdx = median[median.length - 1][0] - median[0][0];
  const tdy = -(median[median.length - 1][1] - median[0][1]);
  const tlen = Math.sqrt(tdx * tdx + tdy * tdy);
  
  // ç‚¹çš„åˆ¤æ–­ï¼šé•¿åº¦å¾ˆçŸ­ â†’ ä¸€å®šæ˜¯ç‚¹
  if (tlen < 35 && median.length <= 5) return 'ç‚¹';

  // åˆ†æç¬”ç”»è·¯å¾„ï¼Œæ‰¾å‡ºæ‰€æœ‰è½¬æŠ˜ç‚¹
  const segments = [];
  for (let i = 1; i < median.length; i++) {
    const dx = median[i][0] - median[i-1][0];
    const dy = -(median[i][1] - median[i-1][1]);
    const len = Math.sqrt(dx * dx + dy * dy);
    if (len > 15) { // å¿½ç•¥å¤ªå°çš„ç‰‡æ®µ
      segments.push({ dx, dy, len, idx: i });
    }
  }

  if (segments.length === 0) return 'ç‚¹';

  // æ£€æµ‹è½¬æŠ˜ç‚¹ï¼ˆè§’åº¦å˜åŒ–å¤§çš„åœ°æ–¹ï¼‰
  const turns = [];
  for (let i = 1; i < segments.length; i++) {
    const a1 = Math.atan2(segments[i-1].dy, segments[i-1].dx);
    const a2 = Math.atan2(segments[i].dy, segments[i].dx);
    let diff = Math.abs(a2 - a1);
    if (diff > Math.PI) diff = 2 * Math.PI - diff;
    const deg = diff * 180 / Math.PI;
    if (deg > 40) { // è½¬æŠ˜è§’åº¦å¤§äº40åº¦
      turns.push({ idx: segments[i].idx, angle: deg });
    }
  }

  // æ— è½¬æŠ˜æˆ–è½¬æŠ˜å¾ˆå° â†’ ç®€å•ç¬”ç”»
  if (turns.length === 0) {
    return dirName(tdx, tdy, tlen);
  }

  // æœ‰è½¬æŠ˜ â†’ å¤åˆç¬”ç”»
  // åˆ†æä¸»è¦è½¬æŠ˜ç‚¹å‰åçš„æ–¹å‘
  const firstSeg = segments[0];
  const lastSeg = segments[segments.length - 1];
  const d1 = getDirection(firstSeg.dx, firstSeg.dy, false);
  const d2 = getDirection(lastSeg.dx, lastSeg.dy, false);
  
  // æ£€æŸ¥æœ«æ®µæ˜¯å¦å‘ä¸Šï¼ˆé’©çš„ç‰¹å¾ï¼‰
  const isHook = lastSeg.dy < -10 && Math.abs(lastSeg.dx) < Math.abs(lastSeg.dy) * 0.8;
  const isUpward = lastSeg.dy < 0;

  // ç‰¹æ®Šå¤åˆç¬”ç”»è¯†åˆ«
  // 1. é’©ç±»ï¼ˆæœ«æ®µå‘ä¸Š/å·¦ä¸Šï¼‰
  if (isHook || d2 === 'æ') {
    if (d1 === 'ç«–') {
      // ç«–å¼¯é’©ï¼šç«–+æ¨ª+æ
      if (turns.length >= 2) {
        const midIdx = Math.floor(segments.length / 2);
        const midSeg = segments[midIdx];
        const midDir = getDirection(midSeg.dx, midSeg.dy, false);
        if (midDir === 'æ¨ª') return 'ç«–å¼¯é’©';
      }
      // ç«–æ vs ç«–é’©ï¼šç«–ææœ«æ®µå‘å³ä¸Š(dx>0)ï¼Œç«–é’©æœ«æ®µå‘å·¦ä¸Š(dx<=0)
      if (lastSeg.dx > 15) return 'ç«–æ';
      return 'ç«–é’©';
    }
    if (d1 === 'æ¨ª') {
      // æ¨ªé’© vs æ¨ªæŠ˜é’©ï¼šæ¨ªé’©æ˜¯æ¨ª+æï¼›æ¨ªæŠ˜é’©æ˜¯æ¨ª+ç«–+æ
      if (turns.length >= 2) return 'æ¨ªæŠ˜é’©';
      return 'æ¨ªé’©';
    }
    if (d1 === 'æ’‡') {
      // æ–œé’© vs æ’‡æŠ˜ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ¨ªæ®µ
      if (turns.length >= 2) {
        const midSeg = segments[Math.floor(segments.length / 2)];
        const midDir = getDirection(midSeg.dx, midSeg.dy, false);
        if (midDir === 'æ¨ª') return 'æ’‡æŠ˜';
      }
      return 'æ–œé’©';
    }
    if (d1 === 'æº') return 'å§é’©';
    return d1 + 'é’©';
  }

  // 2. æ¨ªæŠ˜ç±»
  if (d1 === 'æ¨ª') {
    if (d2 === 'ç«–') {
      // æ¨ªæŠ˜ vs æ¨ªæŠ˜æŠ˜ vs æ¨ªæŠ˜æŠ˜é’©
      if (turns.length >= 3 && isUpward) return 'æ¨ªæŠ˜æŠ˜é’©';
      if (turns.length >= 2) return 'æ¨ªæŠ˜æŠ˜';
      return 'æ¨ªæŠ˜';
    }
    if (d2 === 'æ’‡') return 'æ¨ªæ’‡';
    if (d2 === 'æ' || isUpward) return 'æ¨ªé’©';
    if (d2 === 'æº') {
      if (turns.length >= 2) return 'æ¨ªæŠ˜æŠ˜';
      return 'æ¨ªæŠ˜';
    }
  }

  // 3. ç«–æŠ˜ç±»
  if (d1 === 'ç«–') {
    if (d2 === 'æ¨ª') {
      // ç«–æŠ˜ vs ç«–æŠ˜æŠ˜ vs ç«–æŠ˜æŠ˜é’©
      if (turns.length >= 3 && isUpward) return 'ç«–æŠ˜æŠ˜é’©';
      if (turns.length >= 2) return 'ç«–æŠ˜æŠ˜';
      return 'ç«–æŠ˜';
    }
    // ç«–å¼¯ã€ç«–å¼¯é’©ï¼šç«–åå¸¦å¼¯ï¼Œæœ«æ®µå¯èƒ½æ¨ªæˆ–æ
    if (d2 === 'æ¨ª' && turns.length >= 1) {
      if (isHook || isUpward) return 'ç«–å¼¯é’©';
      return 'ç«–å¼¯';
    }
    if (d2 === 'æ’‡') {
      if (isUpward) return 'ç«–å¼¯é’©';
      return 'ç«–å¼¯';
    }
    if (d2 === 'æ' || isHook) return 'ç«–é’©';
  }

  // 4. æ’‡æŠ˜ç±»
  if (d1 === 'æ’‡') {
    if (d2 === 'æ¨ª' || d2 === 'æ') return 'æ’‡æŠ˜';
    if (d2 === 'ç‚¹' || d2 === 'æº') return 'æ’‡ç‚¹';
    if (d2 === 'ç«–') return 'æ’‡æŠ˜';
  }

  // 5. æºç‚¹
  if (d1 === 'æº' && d2 === 'ç‚¹') return 'æºç‚¹';

  // 6. ç«–å¼¯é’©ï¼ˆç«–åæ¥æ¨ªå†å‘ä¸Šï¼‰- å·²åœ¨ä¸Šé¢å¤„ç†

  // é»˜è®¤ï¼šè¿”å›ä¸»è¦æ–¹å‘+æŠ˜
  return d1 + 'æŠ˜';
}

// è·å–æ–¹å‘ï¼ˆç”¨äºå¤åˆç¬”ç”»åˆ†æï¼Œä¸åŒºåˆ†ç‚¹/æºï¼‰
function getDirection(dx, dy, useLength = true) {
  const a = Math.atan2(dy, dx) * 180 / Math.PI;
  const len = Math.sqrt(dx * dx + dy * dy);
  
  // æï¼š-50Â° ~ -18Â°ï¼ˆå‘ä¸Šåå·¦ï¼Œå…ˆåˆ¤æ–­é¿å…ä¸æ¨ªé‡å ï¼‰
  if (a >= -50 && a < -18) return 'æ';
  
  // æ¨ªï¼š-28Â° ~ 28Â°ï¼ˆæ°´å¹³æ–¹å‘ï¼‰
  if (a >= -28 && a <= 28) return 'æ¨ª';
  
  // ç«–ï¼š58Â° ~ 122Â° æˆ– -122Â° ~ -58Â°ï¼ˆå‚ç›´æ–¹å‘ï¼‰
  if ((a >= 58 && a <= 122) || (a <= -58 && a >= -122)) return 'ç«–';
  
  // æ’‡ï¼š122Â° ~ 180Â° æˆ– -180Â° ~ -152Â°ï¼ˆå·¦ä¸‹ï¼‰
  if ((a >= 122 && a <= 180) || (a <= -152 && a >= -180)) return 'æ’‡';
  
  // æºï¼š28Â° ~ 58Â°ï¼ˆå³ä¸‹ï¼‰
  if (a >= 28 && a < 58) {
    if (useLength && len < 200) return 'ç‚¹';
    return 'æº';
  }
  
  // ç‚¹ï¼š-18Â° ~ 28Â° ä¸”é•¿åº¦çŸ­ï¼ˆå³ä¸ŠçŸ­ç¬”ç”»ï¼‰
  if (a >= -18 && a < 28 && useLength && len < 200) return 'ç‚¹';
  
  // é»˜è®¤æ ¹æ®è§’åº¦åˆ¤æ–­
  if (a > 0 && a < 90) {
    return useLength && len < 180 ? 'ç‚¹' : 'æº';
  }
  if (a >= 90 || a <= -90) return 'æ’‡';
  return 'ç«–';
}

// å±å¹•åæ ‡æ–¹å‘åï¼ˆè€ƒè™‘é•¿åº¦åŒºåˆ†ç‚¹/æºï¼‰
function dirName(dx, dy, len) {
  if (len === undefined) len = Math.sqrt(dx * dx + dy * dy);
  return getDirection(dx, dy, true);
}

// ===== ç”Ÿå­—æ•°æ® =====
const UNITS = [
  { name: 'è¯†å­—ä¸€', icon: 'ğŸ“–', color: '#e8f5e9', lessons: [
    { title: '1 å¤©åœ°äºº', chars: 'ä¸€äºŒä¸‰å››äº”ä¸Šä¸‹' },
    { title: '2 é‡‘æœ¨æ°´ç«åœŸ', chars: 'å£è€³ç›®æ‰‹è¶³ç«™å' },
    { title: '3 å£è€³ç›®', chars: 'æ—¥æœˆæ°´ç«å±±çŸ³ç”°ç¦¾' },
    { title: '4 æ—¥æœˆæ°´ç«', chars: 'å¯¹äº‘é›¨é£èŠ±é¸Ÿè™«' },
    { title: '5 å¯¹éŸµæ­Œ', chars: 'å…­ä¸ƒå…«ä¹å' },
  ]},
  { name: 'è¯¾æ–‡ä¸€', icon: 'ğŸŒ¿', color: '#e3f2fd', lessons: [
    { title: '1 ç§‹å¤©', chars: 'äº†å­äººå¤§' },
    { title: '2 å°å°çš„èˆ¹', chars: 'æœˆå„¿å¤´é‡Œ' },
    { title: '3 æ±Ÿå—', chars: 'å¯ä¸œè¥¿' },
    { title: '4 å››å­£', chars: 'å¤©å››æ˜¯' },
  ]},
  { name: 'è¯†å­—äºŒ', icon: 'ğŸ’', color: '#fff3e0', lessons: [
    { title: '5 ç”»', chars: 'æ°´å»æ¥ä¸' },
    { title: '6 å¤§å°å¤šå°‘', chars: 'å°å°‘ç‰›æœé¸Ÿ' },
    { title: '7 å°ä¹¦åŒ…', chars: 'æ—©ä¹¦åˆ€å°ºæœ¬' },
    { title: '8 æ—¥æœˆæ˜', chars: 'æœ¨æ—åœŸåŠ›å¿ƒ' },
    { title: '9 å‡å›½æ——', chars: 'ä¸­äº”ç«‹æ­£' },
  ]},
  { name: 'è¯¾æ–‡äºŒ', icon: 'ğŸŒˆ', color: '#fce4ec', lessons: [
    { title: '5 å½±å­', chars: 'åœ¨åæˆ‘å¥½' },
    { title: '6 æ¯”å°¾å·´', chars: 'é•¿æ¯”å·´æŠŠ' },
    { title: '7 é’è›™å†™è¯—', chars: 'ä¸‹ä¸ªé›¨ä»¬' },
    { title: '8 é›¨ç‚¹å„¿', chars: 'é—®æœ‰åŠä»ä½ ' },
  ]},
  { name: 'è¯¾æ–‡ä¸‰', icon: 'â­', color: '#f3e5f5', lessons: [
    { title: '9 æ˜å¤©è¦è¿œè¶³', chars: 'æ‰æ˜åŒå­¦' },
    { title: '10 å¤§è¿˜æ˜¯å°', chars: 'è‡ªå·±è¡£' },
    { title: '11 é¡¹é“¾', chars: 'ç™½çš„åˆå’Œ' },
  ]},
  { name: 'è¯¾æ–‡å››', icon: 'ğŸ„', color: '#e8eaf6', lessons: [
    { title: '12 é›ªåœ°é‡Œçš„å°ç”»å®¶', chars: 'ç«¹ç‰™é©¬ç”¨å‡ ' },
    { title: '13 ä¹Œé¸¦å–æ°´', chars: 'çŸ³å¤šå‡ºè§' },
    { title: '14 å°èœ—ç‰›', chars: 'å¯¹å¦ˆå…¨å›' },
  ]},
];

const DIFFICULT_CHARS = new Set('é‡Œå¤´ä¸œè¥¿å››æœä¹¦å°ºåŠä»é—®æœ‰æ‰åŒè¡£ç«¹é©¬å‡ å‡ºå›å…¨'.split(''));

// ===== çŠ¶æ€ =====
let currentView = 'units';
let currentUnit = null;
let currentChar = null;
let currentCharList = []; // å½“å‰å•å…ƒæ‰€æœ‰å­—ï¼Œæ–¹ä¾¿"ä¸‹ä¸€ä¸ª"
let currentCharIndex = -1;
let writer = null;
let quizActive = false;

// ===== localStorage =====
const STORAGE_KEY = 'bishun_records';
const STORAGE_VERSION = '1.0'; // æ•°æ®ç‰ˆæœ¬å·ï¼Œç”¨äºæœªæ¥è¿ç§»

function loadRecords() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return {};
    const parsed = JSON.parse(data);
    // æ£€æŸ¥ç‰ˆæœ¬ï¼Œæœªæ¥å¯ç”¨äºæ•°æ®è¿ç§»
    if (parsed._version !== STORAGE_VERSION) {
      // è¿™é‡Œå¯ä»¥æ·»åŠ ç‰ˆæœ¬è¿ç§»é€»è¾‘
    }
    return parsed;
  } catch (e) {
    console.error('è¯»å–å­¦ä¹ è®°å½•å¤±è´¥:', e);
    if (e.name === 'QuotaExceededError') {
      showError('ğŸ’¾ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜');
    }
    return {};
  }
}

function saveRecords(r) {
  try {
    // æ£€æŸ¥å­˜å‚¨é…é¢
    if (!checkStorageQuota()) {
      showError('ğŸ’¾ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•ä¿å­˜å­¦ä¹ è®°å½•');
      return false;
    }
    r._version = STORAGE_VERSION;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(r));
    return true;
  } catch (e) {
    console.error('ä¿å­˜å­¦ä¹ è®°å½•å¤±è´¥:', e);
    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
      showError('ğŸ’¾ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜åé‡è¯•');
    } else {
      showError('âš ï¸ ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
    return false;
  }
}

function getCharRecord(ch) {
  const r = loadRecords();
  return r[ch] || { attempts: 0, correct: 0 };
}

function recordResult(ch, isCorrect) {
  const r = loadRecords();
  if (!r[ch]) r[ch] = { attempts: 0, correct: 0 };
  r[ch].attempts++;
  if (isCorrect) r[ch].correct++;
  const saved = saveRecords(r);
  if (!saved) {
    // ä¿å­˜å¤±è´¥æ—¶ï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®
    try {
      const allChars = UNITS.flatMap(u => u.lessons.flatMap(l => l.chars.split('')));
      const oldChars = Object.keys(r).filter(k => k !== '_version' && !allChars.includes(k));
      oldChars.forEach(k => delete r[k]);
      saveRecords(r);
    } catch (e) {
      console.error('æ¸…ç†æ—§æ•°æ®å¤±è´¥:', e);
    }
  }
}

// ===== æ˜Ÿæ˜Ÿç­‰çº§ =====
function getStars(rec) {
  if (rec.attempts === 0) return '';
  const rate = rec.correct / rec.attempts;
  if (rate >= 0.8) return 'â­â­â­';
  if (rate >= 0.5) return 'â­â­';
  return 'â­';
}
function getStarLabel(rec) {
  if (rec.attempts === 0) return 'è¿˜æ²¡ç»ƒè¿‡';
  const rate = Math.round(rec.correct / rec.attempts * 100);
  const stars = getStars(rec);
  return `${stars} ç»ƒäº†${rec.attempts}æ¬¡`;
}

function showNav(show) {
  const m = show ? 'add' : 'remove';
  document.getElementById('backBtn').classList[m]('show');
  document.getElementById('homeBtn').classList[m]('show');
}

// ===== é¡µé¢åˆ‡æ¢ =====
function showOnly(id) {
  ['unitList','charPage','practicePage','summaryPage'].forEach(k => {
    document.getElementById(k).classList.add('page-hidden');
  });
  const el = document.getElementById(id);
  el.classList.remove('page-hidden');
  if (id === 'practicePage') el.style.display = 'flex';
  else el.style.display = '';
  el.classList.remove('fade-in');
  void el.offsetWidth;
  el.classList.add('fade-in');
}

// ===== å•å…ƒåˆ—è¡¨ =====
function renderUnits() {
  currentView = 'units';
  showNav(false);
  document.getElementById('headerTitle').innerHTML = '&#9997;&#65039; å†™å­—å°è¯¾å ‚';
  showOnly('unitList');

  const records = loadRecords();
  document.getElementById('unitList').innerHTML = UNITS.map((u, i) => {
    const allChars = u.lessons.flatMap(l => l.chars.split(''));
    const practiced = allChars.filter(c => records[c] && records[c].attempts > 0).length;
    const pct = allChars.length ? Math.round(practiced / allChars.length * 100) : 0;
    return `<div class="unit-card" onclick="openUnit(${i})">
      <div class="unit-icon" style="background:${u.color}">${u.icon}</div>
      <div style="flex:1">
        <h3>${u.name}</h3>
        <div class="progress-text">å·²ç»ƒ ${practiced}/${allChars.length} ä¸ªå­—</div>
        <div class="progress-bar"><div class="fill" style="width:${pct}%"></div></div>
      </div>
      <span class="arrow">â€º</span>
    </div>`;
  }).join('');
}

// ===== ç”Ÿå­—ç½‘æ ¼ =====
function openUnit(idx) {
  currentView = 'chars';
  currentUnit = idx;
  const unit = UNITS[idx];
  showNav(true);
  document.getElementById('headerTitle').textContent = unit.icon + ' ' + unit.name;
  showOnly('charPage');

  // æ„å»ºå½“å‰å•å…ƒå­—åˆ—è¡¨
  currentCharList = unit.lessons.flatMap(l => l.chars.split(''));

  const records = loadRecords();
  let html = '';
  unit.lessons.forEach(lesson => {
    html += `<div class="lesson-title">${lesson.title}</div><div class="char-grid">`;
    lesson.chars.split('').forEach(ch => {
      const rec = records[ch] || { attempts: 0, correct: 0 };
      const stars = getStars(rec);
      const rate = rec.attempts > 0 ? rec.correct / rec.attempts : -1;
      let cls = '';
      if (rate >= 0.8) cls = 'mastered';
      else if (rate >= 0 && rate < 0.5) cls = 'struggling';
      const dot = DIFFICULT_CHARS.has(ch) ? '<span class="difficult-dot">&#128293;</span>' : '';
      html += `<div class="char-cell ${cls}" onclick="openPractice('${ch}')">
        ${dot}${ch}<span class="stars">${stars}</span></div>`;
    });
    html += '</div>';
  });
  // è®¡ç®—è–„å¼±å­—ï¼ˆæ­£ç¡®ç‡<50%ä¸”ç»ƒä¹ è¿‡ï¼‰
  const allChars = unit.lessons.flatMap(l => l.chars.split(''));
  const weakChars = allChars.filter(ch => {
    const rec = records[ch];
    if (!rec || rec.attempts === 0) return false;
    const rate = rec.correct / rec.attempts;
    return rate < 0.5;
  });

  html += `<div class="btn-row" style="margin-top:24px">
    <button class="btn btn-warning btn-small" onclick="showSummary()">&#128202; çœ‹çœ‹æŒæ¡æƒ…å†µ</button>
    ${weakChars.length > 0 ? `<button class="btn btn-danger btn-small" onclick="reviewWeakChars(${JSON.stringify(weakChars)})">&#128293; å¤ä¹ è–„å¼±å­— (${weakChars.length})</button>` : ''}
  </div>`;
  document.getElementById('charPage').innerHTML = html;
}

// ===== ç»ƒä¹ é¡µ =====
async function openPractice(ch) {
  currentView = 'practice';
  currentChar = ch;
  // æ›´æ–°ç´¢å¼•ï¼ˆå¤ä¹ æ¨¡å¼ä½¿ç”¨reviewCharIndexï¼Œæ™®é€šæ¨¡å¼ä½¿ç”¨currentCharIndexï¼‰
  if (reviewMode) {
    currentCharIndex = reviewCharIndex;
  } else {
    currentCharIndex = currentCharList.indexOf(ch);
  }
  quizActive = false;
  clearStrokeSpeech();
  showNav(true);
  const titlePrefix = reviewMode ? 'ğŸ“š å¤ä¹ ï¼š' : 'ç»ƒä¹ ï¼š';
  document.getElementById('headerTitle').textContent = titlePrefix + ch;
  showOnly('practicePage');

  // å¤´éƒ¨
  const diff = DIFFICULT_CHARS.has(ch) ? '<span class="char-tag">&#128293; æ˜“é”™å­—ï¼Œè¦å¤šç»ƒ</span>' : '';
  document.getElementById('practiceHeader').innerHTML = `<div class="big-char">${ch}</div>${diff}`;

  // ç»Ÿè®¡
  updateStatsStars(ch);

  // æŒ‰é’®ï¼šåˆå§‹çŠ¶æ€
  renderPracticeButtons('init');

  // æ¸…ç©ºåé¦ˆ
  document.getElementById('feedbackArea').innerHTML = '<div class="feedback-text hint">&#128264; å¬ä¸€å¬ï¼Œçœ‹ä¸€çœ‹â€¦</div>';

  // åŠ è½½ç¬”ç”»æ•°æ®ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼Œå¸¦ç¼“å­˜å’Œé”™è¯¯å¤„ç†ï¼‰
  try {
    await loadStrokeNames(ch);
  } catch (e) {
    console.error('åŠ è½½ç¬”ç”»æ•°æ®å¼‚å¸¸:', e);
    // é”™è¯¯å·²åœ¨loadStrokeNamesä¸­å¤„ç†ï¼Œè¿™é‡Œç»§ç»­æ‰§è¡Œ
  }

  // å…ˆè¯»å­—éŸ³
  speak(ch, 0.7);

  // åˆ›å»º Writer
  const wrap = document.getElementById('writerWrap');
  const size = Math.min(320, wrap.clientWidth) - 6;
  document.getElementById('writerTarget').innerHTML = '';
  writer = HanziWriter.create('writerTarget', ch, {
    width: size, height: size, padding: 10,
    showOutline: true, showCharacter: false,
    strokeAnimationSpeed: 1, delayBetweenStrokes: 1200,
    strokeColor: '#333', outlineColor: '#ddd',
    drawingColor: '#5b8ff9', drawingWidth: 8,
    showHintAfterMisses: 2,
    highlightOnComplete: true,
    highlightColor: '#52c41a',
  });

  // ç­‰å­—éŸ³æ’­å®Œåå¼€å§‹åŠ¨ç”»ï¼ˆçº¦800msåï¼‰
  setTimeout(() => {
    if (currentChar !== ch) return; // å·²åˆ‡æ¢åˆ°åˆ«çš„å­—
    animateWithStrokeNames();
  }, 900);
}

// æ’­æ”¾ç¬”é¡ºåŠ¨ç”»ï¼ŒåŒæ—¶æŠ¥è¯»æ¯ä¸€ç¬”çš„ç¬”ç”»åç§°
function animateWithStrokeNames() {
  if (!writer) return;
  clearStrokeSpeech();

  const names = currentStrokeNames;
  // ä¼°ç®—æ¯ç¬”æ—¶é—´ï¼šåŠ¨ç”»çº¦ 400ms + é—´éš” 1200ms = 1600ms
  const INTERVAL = 1600;

  // åœ¨æ¯ç¬”å¼€å§‹æ—¶æŠ¥ç¬”ç”»å
  if (names.length > 0) {
    names.forEach((name, i) => {
      const t = setTimeout(() => {
        speakQueue(name, 0.8);
        // åŒæ—¶æ›´æ–°åé¦ˆåŒºæ˜¾ç¤ºç¬”ç”»å
        document.getElementById('feedbackArea').innerHTML =
          `<div class="feedback-text hint">ç¬¬${i + 1}ç¬”ï¼š${name}</div>`;
      }, i * INTERVAL);
      strokeSpeechTimers.push(t);
    });
  }

  writer.animateCharacter({
    onComplete: () => {
      SFX.ready();
      // åŠ¨ç”»ç»“æŸåæ˜¾ç¤ºç¬”ç”»æ€»ç»“
      const summary = names.length > 0
        ? `<div style="font-size:14px;color:var(--text-light);margin-top:4px">ç¬”é¡ºï¼š${names.join(' - ')}</div>`
        : '';
      document.getElementById('feedbackArea').innerHTML =
        `<div class="feedback-text hint">&#128079; çœ‹å®Œå•¦ï¼ç‚¹ä¸‹é¢æŒ‰é’®è‡ªå·±å†™å†™çœ‹</div>${summary}`;
      renderPracticeButtons('ready');
    }
  });
}

function renderPracticeButtons(state) {
  const el = document.getElementById('practiceButtons');
  let hasNext = false;
  if (reviewMode) {
    hasNext = reviewCharIndex >= 0 && reviewCharIndex < reviewCharList.length - 1;
  } else {
    hasNext = currentCharIndex >= 0 && currentCharIndex < currentCharList.length - 1;
  }
  
  if (state === 'init') {
    el.innerHTML = `<button class="btn btn-primary btn-small" onclick="playAnimation()">&#128065; å†çœ‹ä¸€é</button>`;
  } else if (state === 'ready') {
    el.innerHTML = `
      <button class="btn btn-success" onclick="startQuiz()">&#9997;&#65039; æˆ‘æ¥å†™ï¼</button>
      <button class="btn btn-outline btn-small" onclick="playAnimation()">&#128065; å†çœ‹ä¸€é</button>`;
  } else if (state === 'quizzing') {
    el.innerHTML = `<button class="btn btn-outline btn-small" onclick="resetChar()">&#128260; é‡æ–°å†™</button>`;
  } else if (state === 'done') {
    const reviewBadge = reviewMode ? `<span style="font-size:12px;background:#ff4d4f;color:#fff;padding:2px 8px;border-radius:10px;margin-left:8px">å¤ä¹ æ¨¡å¼</span>` : '';
    el.innerHTML = `
      <button class="btn btn-success btn-small" onclick="startQuiz()">&#9997;&#65039; å†å†™ä¸€æ¬¡</button>
      <button class="btn btn-outline btn-small" onclick="playAnimation()">&#128065; çœ‹ç¬”é¡º</button>
      ${hasNext ? `<button class="btn btn-next btn-small" onclick="nextChar()">&#128073; ä¸‹ä¸€ä¸ªå­—</button>${reviewBadge}` : reviewBadge}`;
  }
}

function playAnimation() {
  if (!writer) return;
  SFX.tap();
  quizActive = false;
  // å…ˆè¯»ä¸€éå­—éŸ³
  speak(currentChar, 0.7);
  document.getElementById('feedbackArea').innerHTML = '<div class="feedback-text hint">&#128064; ä»”ç»†çœ‹å“¦â€¦</div>';
  writer.hideCharacter();
  setTimeout(() => animateWithStrokeNames(), 700);
}

function startQuiz() {
  if (!writer) return;
  SFX.tap();
  quizActive = true;
  document.getElementById('feedbackArea').innerHTML =
    '<div class="feedback-text hint">&#128221; ç”¨æ‰‹æŒ‡æŒ‰é¡ºåºå†™å§ï¼</div>';
  renderPracticeButtons('quizzing');
  writer.hideCharacter();
  writer.quiz({
    onMistake(sd) {
      SFX.wrong();
      const expected = currentStrokeNames[sd.strokeNum] || '';
      const hint = expected ? `ï¼Œè¿™ä¸€ç¬”æ˜¯${expected}` : '';
      document.getElementById('feedbackArea').innerHTML =
        `<div class="feedback-text wrong">&#128528; ä¸å¤ªå¯¹${hint}ï¼Œå†è¯•è¯•</div>`;
    },
    onCorrectStroke(sd) {
      SFX.correct();
      const sName = currentStrokeNames[sd.strokeNum] || '';
      const encourages = ['&#128077; å¯¹å•¦ï¼', '&#127775; çœŸæ£’ï¼', '&#128522; æ²¡é”™ï¼', '&#128170; ç»§ç»­ï¼', '&#10004;&#65039; å¾ˆå¥½ï¼'];
      const msg = encourages[sd.strokeNum % encourages.length];
      const nameTag = sName ? `<div style="font-size:15px;color:var(--text-light);margin-top:2px">${sName}</div>` : '';
      document.getElementById('feedbackArea').innerHTML =
        `<div class="feedback-text correct">${msg}</div>${nameTag}`;
      if (sName) speakQueue(sName, 0.9);
    },
    onComplete(summary) {
      quizActive = false;
      const ok = summary.totalMistakes === 0;
      recordResult(currentChar, ok);
      updateStatsStars(currentChar);
      renderPracticeButtons('done');
      if (ok) {
        SFX.perfect();
        document.getElementById('feedbackArea').innerHTML =
          `<div class="feedback-emoji">&#127881;&#127881;&#127881;</div>
           <div class="feedback-text correct">å¤ªæ£’äº†ï¼å…¨éƒ¨æ­£ç¡®ï¼</div>`;
        celebrate();
      } else if (summary.totalMistakes <= 2) {
        SFX.done();
        document.getElementById('feedbackArea').innerHTML =
          `<div class="feedback-emoji">&#128170;</div>
           <div class="feedback-text" style="color:#fa8c16">ä¸é”™å“¦ï¼Œå†ç»ƒç»ƒå°±æ›´å¥½äº†ï¼</div>`;
      } else {
        SFX.done();
        document.getElementById('feedbackArea').innerHTML =
          `<div class="feedback-emoji">&#128588;</div>
           <div class="feedback-text" style="color:var(--primary)">åŠ æ²¹ï¼å¤šçœ‹å‡ éç¬”é¡ºå†å†™</div>`;
      }
    }
  });
}

function resetChar() { if (currentChar) openPractice(currentChar); }

// ===== è–„å¼±å­—å¤ä¹ æ¨¡å¼ =====
let reviewMode = false;
let reviewCharList = [];
let reviewCharIndex = -1;

function reviewWeakChars(chars) {
  if (!chars || chars.length === 0) {
    showError('æ²¡æœ‰éœ€è¦å¤ä¹ çš„è–„å¼±å­—', 2000);
    return;
  }
  
  reviewMode = true;
  reviewCharList = chars;
  reviewCharIndex = 0;
  
  // æ˜¾ç¤ºå¤ä¹ æ¨¡å¼æç¤º
  showError(`ğŸ“š å¼€å§‹å¤ä¹  ${chars.length} ä¸ªè–„å¼±å­—`, 2000);
  
  // å¼€å§‹å¤ä¹ ç¬¬ä¸€ä¸ªå­—
  openPractice(chars[0]);
  
  // æ›´æ–°å½“å‰å­—ç¬¦åˆ—è¡¨ï¼Œä»¥ä¾¿"ä¸‹ä¸€ä¸ª"æŒ‰é’®æ­£å¸¸å·¥ä½œ
  currentCharList = chars;
  currentCharIndex = 0;
}

// ä¿®æ”¹nextCharå‡½æ•°ä»¥æ”¯æŒå¤ä¹ æ¨¡å¼
function nextChar() {
  if (reviewMode && reviewCharIndex < reviewCharList.length - 1) {
    reviewCharIndex++;
    currentCharIndex = reviewCharIndex;
    openPractice(reviewCharList[reviewCharIndex]);
  } else if (!reviewMode && currentCharIndex < currentCharList.length - 1) {
    currentCharIndex++;
    openPractice(currentCharList[currentCharIndex]);
  } else if (reviewMode && reviewCharIndex >= reviewCharList.length - 1) {
    // å¤ä¹ å®Œæˆ
    reviewMode = false;
    showError('ğŸ‰ è–„å¼±å­—å¤ä¹ å®Œæˆï¼', 3000);
    // è¿”å›å•å…ƒé¡µé¢
    setTimeout(() => {
      if (currentUnit !== null) {
        openUnit(currentUnit);
      }
    }, 1500);
  }
}

function updateStatsStars(ch) {
  const rec = getCharRecord(ch);
  document.getElementById('statsStars').textContent = getStarLabel(rec);
}

// ===== åº†ç¥æ’’èŠ± =====
function celebrate() {
  const container = document.createElement('div');
  container.className = 'celebrate';
  document.body.appendChild(container);
  const colors = ['#ff6b6b','#ffd93d','#6bcb77','#4d96ff','#ff922b','#cc5de8','#20c997'];
  for (let i = 0; i < 40; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.left = Math.random() * 100 + '%';
    c.style.top = -10 + 'px';
    c.style.background = colors[Math.floor(Math.random() * colors.length)];
    c.style.animationDelay = Math.random() * 0.5 + 's';
    c.style.width = (6 + Math.random() * 8) + 'px';
    c.style.height = (6 + Math.random() * 8) + 'px';
    container.appendChild(c);
  }
  setTimeout(() => container.remove(), 2200);
}

// ===== æ€»ç»“é¡µ =====
function showSummary() {
  if (currentUnit === null) return;
  currentView = 'summary';
  const unit = UNITS[currentUnit];
  showOnly('summaryPage');

  const records = loadRecords();
  const allChars = unit.lessons.flatMap(l => l.chars.split(''));
  const mastered = allChars.filter(c => { const r = records[c]; return r && r.attempts > 0 && r.correct / r.attempts >= 0.8; }).length;
  const practiced = allChars.filter(c => records[c] && records[c].attempts > 0).length;

  let emoji = '&#128170;';
  let comment = 'ç»§ç»­åŠ æ²¹ï¼';
  if (mastered === allChars.length) { emoji = '&#127942;'; comment = 'å…¨éƒ¨æŒæ¡äº†ï¼Œä½ çœŸå‰å®³ï¼'; }
  else if (mastered > allChars.length * 0.6) { emoji = '&#127775;'; comment = 'å­¦å¾—å¾ˆå¥½ï¼Œå†ç»ƒç»ƒå°±å…¨ä¼šäº†ï¼'; }
  else if (practiced > 0) { emoji = '&#128522;'; comment = 'æœ‰è¿›æ­¥å“¦ï¼Œç»§ç»­ç»ƒä¹ ï¼'; }
  else { emoji = '&#128075;'; comment = 'å¼€å§‹ç»ƒä¹ å§ï¼'; }

  let html = `<div class="summary-header">
    <div class="big-emoji">${emoji}</div>
    <h2>${unit.name}</h2>
    <div class="sub">${comment} å·²æŒæ¡ ${mastered}/${allChars.length} ä¸ªå­—</div>
  </div><div class="summary-list">`;

  allChars.forEach(ch => {
    const rec = records[ch] || { attempts: 0, correct: 0 };
    const stars = getStars(rec);
    let badge, info;
    if (rec.attempts === 0) {
      badge = '<span class="badge badge-new">&#128218; è¿˜æ²¡ç»ƒ</span>';
      info = '';
    } else {
      const rate = rec.correct / rec.attempts;
      info = `ç»ƒäº†${rec.attempts}æ¬¡ ${stars}`;
      if (rate >= 0.8) badge = '<span class="badge badge-star">&#127775; æŒæ¡äº†</span>';
      else if (rate >= 0.5) badge = '<span class="badge badge-try">&#128170; è¿˜è¦ç»ƒ</span>';
      else badge = '<span class="badge badge-hard">&#128293; å¤šç»ƒç»ƒ</span>';
    }
    const diff = DIFFICULT_CHARS.has(ch) ? ' <span style="font-size:12px">&#128293;æ˜“é”™</span>' : '';
    html += `<div class="summary-item" onclick="openPractice('${ch}')" style="cursor:pointer">
      <span class="ch">${ch}</span><span class="info">${info}${diff}</span>${badge}</div>`;
  });

  html += `</div><div class="btn-row" style="margin-top:20px">
    <button class="btn btn-primary btn-small" onclick="goBack()">&#128072; è¿”å›</button>
  </div>`;
  document.getElementById('summaryPage').innerHTML = html;
}

// ===== å¯¼èˆª =====
function goBack() {
  clearStrokeSpeech();
  // é€€å‡ºå¤ä¹ æ¨¡å¼
  if (reviewMode) {
    reviewMode = false;
    reviewCharList = [];
    reviewCharIndex = -1;
  }
  if (currentView === 'practice' && currentUnit !== null) {
    openUnit(currentUnit);
  } else if (currentView === 'summary' && currentUnit !== null) {
    openUnit(currentUnit);
  } else {
    renderUnits();
  }
}

// åˆå§‹åŒ–
document.getElementById('soundBtn').innerHTML = soundEnabled ? '&#128264;' : '&#128263;';

// ç›‘å¬ç½‘ç»œçŠ¶æ€
window.addEventListener('online', () => {
  showError('âœ… ç½‘ç»œå·²è¿æ¥', 2000);
});

window.addEventListener('offline', () => {
  showError('ğŸ“¡ ç½‘ç»œå·²æ–­å¼€', 3000);
});

// åˆå§‹åŒ–åº”ç”¨
renderUnits();
</script>
</body>
</html>
